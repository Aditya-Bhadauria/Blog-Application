{
  "version": 3,
  "sources": ["../valtio/esm/index.js"],
  "sourcesContent": ["import { snapshot, subscribe, getVersion } from 'valtio/vanilla';\r\nexport * from 'valtio/vanilla';\r\nimport { useRef, useState, useEffect, useReducer, useCallback, useMemo, useLayoutEffect, useDebugValue } from 'react';\r\nimport { isChanged, createProxy, affectedToPathList } from 'proxy-compare';\r\n\r\nconst TARGET = Symbol();\r\nconst GET_VERSION = Symbol();\r\nconst createMutableSource = (target, getVersion) => ({\r\n  [TARGET]: target,\r\n  [GET_VERSION]: getVersion\r\n});\r\nconst useMutableSource = (source, getSnapshot, subscribe) => {\r\n  const lastVersion = useRef(0);\r\n  const currentVersion = source[GET_VERSION](source[TARGET]);\r\n  const [state, setState] = useState(() => [\r\n    source,\r\n    getSnapshot,\r\n    subscribe,\r\n    currentVersion,\r\n    getSnapshot(source[TARGET])\r\n  ]);\r\n  let currentSnapshot = state[4];\r\n  if (state[0] !== source || state[1] !== getSnapshot || state[2] !== subscribe) {\r\n    currentSnapshot = getSnapshot(source[TARGET]);\r\n    setState([\r\n      source,\r\n      getSnapshot,\r\n      subscribe,\r\n      currentVersion,\r\n      currentSnapshot\r\n    ]);\r\n  } else if (currentVersion !== state[3] && currentVersion !== lastVersion.current) {\r\n    currentSnapshot = getSnapshot(source[TARGET]);\r\n    if (!Object.is(currentSnapshot, state[4])) {\r\n      setState([\r\n        source,\r\n        getSnapshot,\r\n        subscribe,\r\n        currentVersion,\r\n        currentSnapshot\r\n      ]);\r\n    }\r\n  }\r\n  useEffect(() => {\r\n    let didUnsubscribe = false;\r\n    const checkForUpdates = () => {\r\n      if (didUnsubscribe) {\r\n        return;\r\n      }\r\n      try {\r\n        const nextSnapshot = getSnapshot(source[TARGET]);\r\n        const nextVersion = source[GET_VERSION](source[TARGET]);\r\n        lastVersion.current = nextVersion;\r\n        setState((prev) => {\r\n          if (prev[0] !== source || prev[1] !== getSnapshot || prev[2] !== subscribe) {\r\n            return prev;\r\n          }\r\n          if (Object.is(prev[4], nextSnapshot)) {\r\n            return prev;\r\n          }\r\n          return [\r\n            prev[0],\r\n            prev[1],\r\n            prev[2],\r\n            nextVersion,\r\n            nextSnapshot\r\n          ];\r\n        });\r\n      } catch (e) {\r\n        setState((prev) => [...prev]);\r\n      }\r\n    };\r\n    const unsubscribe = subscribe(source[TARGET], checkForUpdates);\r\n    checkForUpdates();\r\n    return () => {\r\n      didUnsubscribe = true;\r\n      unsubscribe();\r\n    };\r\n  }, [source, getSnapshot, subscribe]);\r\n  return currentSnapshot;\r\n};\r\n\r\nconst isSSR = typeof window === \"undefined\" || !window.navigator || /ServerSideRendering|^Deno\\//.test(window.navigator.userAgent);\r\nconst useIsomorphicLayoutEffect = isSSR ? useEffect : useLayoutEffect;\r\nconst useAffectedDebugValue = (state, affected) => {\r\n  const pathList = useRef();\r\n  useEffect(() => {\r\n    pathList.current = affectedToPathList(state, affected);\r\n  });\r\n  useDebugValue(pathList.current);\r\n};\r\nconst mutableSourceCache = new WeakMap();\r\nconst getMutableSource = (proxyObject) => {\r\n  if (!mutableSourceCache.has(proxyObject)) {\r\n    mutableSourceCache.set(proxyObject, createMutableSource(proxyObject, getVersion));\r\n  }\r\n  return mutableSourceCache.get(proxyObject);\r\n};\r\nconst useSnapshot = (proxyObject, options) => {\r\n  const forceUpdate = useReducer((c) => c + 1, 0)[1];\r\n  const affected = new WeakMap();\r\n  const lastAffected = useRef();\r\n  const prevSnapshot = useRef();\r\n  const lastSnapshot = useRef();\r\n  useIsomorphicLayoutEffect(() => {\r\n    lastSnapshot.current = prevSnapshot.current = snapshot(proxyObject);\r\n  }, [proxyObject]);\r\n  useIsomorphicLayoutEffect(() => {\r\n    lastAffected.current = affected;\r\n    if (prevSnapshot.current !== lastSnapshot.current && isChanged(prevSnapshot.current, lastSnapshot.current, affected, new WeakMap())) {\r\n      prevSnapshot.current = lastSnapshot.current;\r\n      forceUpdate();\r\n    }\r\n  });\r\n  const notifyInSync = options == null ? void 0 : options.sync;\r\n  const sub = useCallback((proxyObject2, cb) => subscribe(proxyObject2, () => {\r\n    const nextSnapshot = snapshot(proxyObject2);\r\n    lastSnapshot.current = nextSnapshot;\r\n    try {\r\n      if (lastAffected.current && !isChanged(prevSnapshot.current, nextSnapshot, lastAffected.current, new WeakMap())) {\r\n        return;\r\n      }\r\n    } catch (e) {\r\n    }\r\n    prevSnapshot.current = nextSnapshot;\r\n    cb();\r\n  }, notifyInSync), [notifyInSync]);\r\n  const currSnapshot = useMutableSource(getMutableSource(proxyObject), snapshot, sub);\r\n  if (typeof process === \"object\" && process.env.NODE_ENV !== \"production\") {\r\n    useAffectedDebugValue(currSnapshot, affected);\r\n  }\r\n  const proxyCache = useMemo(() => new WeakMap(), []);\r\n  return createProxy(currSnapshot, affected, proxyCache);\r\n};\r\n\r\nexport { useSnapshot };\r\n"],
  "mappings": "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",
  "names": []
}

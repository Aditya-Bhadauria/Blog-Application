{
  "version": 3,
  "sources": ["../valtio/esm/utils.js"],
  "sourcesContent": ["import { createProxy, isChanged } from 'proxy-compare';\r\nimport { subscribe, snapshot, proxy, ref } from 'valtio/vanilla';\r\n\r\nconst subscribeKey = (proxyObject, key, callback, notifyInSync) => subscribe(proxyObject, (ops) => {\r\n  if (ops.some((op) => op[1][0] === key)) {\r\n    callback(proxyObject[key]);\r\n  }\r\n}, notifyInSync);\r\nconst devtools = (proxyObject, name) => {\r\n  let extension;\r\n  try {\r\n    extension = window.__REDUX_DEVTOOLS_EXTENSION__;\r\n  } catch {\r\n  }\r\n  if (!extension) {\r\n    if (typeof process === \"object\" && process.env.NODE_ENV === \"development\" && typeof window !== \"undefined\") {\r\n      console.warn(\"[Warning] Please install/enable Redux devtools extension\");\r\n    }\r\n    return;\r\n  }\r\n  let isTimeTraveling = false;\r\n  const devtools2 = extension.connect({ name });\r\n  const unsub1 = subscribe(proxyObject, () => {\r\n    if (isTimeTraveling) {\r\n      isTimeTraveling = false;\r\n    } else {\r\n      devtools2.send(`Update - ${new Date().toLocaleString()}`, snapshot(proxyObject));\r\n    }\r\n  });\r\n  const unsub2 = devtools2.subscribe((message) => {\r\n    var _a, _b, _c, _d, _e, _f;\r\n    if (message.type === \"DISPATCH\" && message.state) {\r\n      if (((_a = message.payload) == null ? void 0 : _a.type) === \"JUMP_TO_ACTION\" || ((_b = message.payload) == null ? void 0 : _b.type) === \"JUMP_TO_STATE\") {\r\n        isTimeTraveling = true;\r\n      }\r\n      const nextValue = JSON.parse(message.state);\r\n      Object.keys(nextValue).forEach((key) => {\r\n        proxyObject[key] = nextValue[key];\r\n      });\r\n    } else if (message.type === \"DISPATCH\" && ((_c = message.payload) == null ? void 0 : _c.type) === \"COMMIT\") {\r\n      devtools2.init(snapshot(proxyObject));\r\n    } else if (message.type === \"DISPATCH\" && ((_d = message.payload) == null ? void 0 : _d.type) === \"IMPORT_STATE\") {\r\n      const actions = (_e = message.payload.nextLiftedState) == null ? void 0 : _e.actionsById;\r\n      const computedStates = ((_f = message.payload.nextLiftedState) == null ? void 0 : _f.computedStates) || [];\r\n      isTimeTraveling = true;\r\n      computedStates.forEach(({ state }, index) => {\r\n        const action = actions[index] || `Update - ${new Date().toLocaleString()}`;\r\n        Object.keys(state).forEach((key) => {\r\n          proxyObject[key] = state[key];\r\n        });\r\n        if (index === 0) {\r\n          devtools2.init(snapshot(proxyObject));\r\n        } else {\r\n          devtools2.send(action, snapshot(proxyObject));\r\n        }\r\n      });\r\n    }\r\n  });\r\n  devtools2.init(snapshot(proxyObject));\r\n  return () => {\r\n    unsub1();\r\n    unsub2();\r\n  };\r\n};\r\nconst addComputed = (proxyObject, computedFns, targetObject = proxyObject) => {\r\n  Object.keys(computedFns).forEach((key) => {\r\n    if (Object.getOwnPropertyDescriptor(targetObject, key)) {\r\n      throw new Error(\"object property already defined\");\r\n    }\r\n    const get = computedFns[key];\r\n    let prevSnapshot;\r\n    let affected = new WeakMap();\r\n    let pending = false;\r\n    const callback = () => {\r\n      const nextSnapshot = snapshot(proxyObject);\r\n      if (!pending && (!prevSnapshot || isChanged(prevSnapshot, nextSnapshot, affected))) {\r\n        affected = new WeakMap();\r\n        const value = get(createProxy(nextSnapshot, affected));\r\n        prevSnapshot = nextSnapshot;\r\n        if (value instanceof Promise) {\r\n          pending = true;\r\n          value.then((v) => {\r\n            targetObject[key] = v;\r\n          }).catch((e) => {\r\n            targetObject[key] = new Proxy({}, {\r\n              get() {\r\n                throw e;\r\n              }\r\n            });\r\n          }).finally(() => {\r\n            pending = false;\r\n          });\r\n        }\r\n        targetObject[key] = value;\r\n      }\r\n    };\r\n    subscribe(proxyObject, callback);\r\n    callback();\r\n  });\r\n};\r\nconst proxyWithComputed = (initialObject, computedFns) => {\r\n  Object.keys(computedFns).forEach((key) => {\r\n    if (Object.getOwnPropertyDescriptor(initialObject, key)) {\r\n      throw new Error(\"object property already defined\");\r\n    }\r\n    const computedFn = computedFns[key];\r\n    const { get, set } = typeof computedFn === \"function\" ? { get: computedFn } : computedFn;\r\n    let computedValue;\r\n    let prevSnapshot;\r\n    let affected = new WeakMap();\r\n    const desc = {};\r\n    desc.get = () => {\r\n      const nextSnapshot = snapshot(proxyObject);\r\n      if (!prevSnapshot || isChanged(prevSnapshot, nextSnapshot, affected)) {\r\n        affected = new WeakMap();\r\n        computedValue = get(createProxy(nextSnapshot, affected));\r\n        prevSnapshot = nextSnapshot;\r\n      }\r\n      return computedValue;\r\n    };\r\n    if (set) {\r\n      desc.set = (newValue) => set(proxyObject, newValue);\r\n    }\r\n    Object.defineProperty(initialObject, key, desc);\r\n  });\r\n  const proxyObject = proxy(initialObject);\r\n  return proxyObject;\r\n};\r\nlet currentCleanups;\r\nconst watch = (callback) => {\r\n  const cleanups = new Set();\r\n  const subscriptions = new Set();\r\n  let alive = true;\r\n  const cleanup = () => {\r\n    cleanups.forEach((clean) => {\r\n      clean();\r\n    });\r\n    cleanups.clear();\r\n    subscriptions.clear();\r\n  };\r\n  const revalidate = () => {\r\n    if (!alive) {\r\n      return;\r\n    }\r\n    cleanup();\r\n    const parent = currentCleanups;\r\n    currentCleanups = cleanups;\r\n    try {\r\n      const cleanupReturn = callback((proxy2) => {\r\n        subscriptions.add(proxy2);\r\n        return proxy2;\r\n      });\r\n      if (cleanupReturn) {\r\n        cleanups.add(cleanupReturn);\r\n      }\r\n    } finally {\r\n      currentCleanups = parent;\r\n    }\r\n    subscriptions.forEach((proxy2) => {\r\n      const clean = subscribe(proxy2, revalidate);\r\n      cleanups.add(clean);\r\n    });\r\n  };\r\n  const wrappedCleanup = () => {\r\n    if (alive) {\r\n      cleanup();\r\n      alive = false;\r\n    }\r\n  };\r\n  if (currentCleanups) {\r\n    currentCleanups.add(wrappedCleanup);\r\n  }\r\n  revalidate();\r\n  return wrappedCleanup;\r\n};\r\nconst proxyWithHistory = (initialValue) => {\r\n  const proxyObject = proxy({\r\n    value: initialValue,\r\n    history: ref({\r\n      wip: initialValue,\r\n      snapshots: [],\r\n      index: -1\r\n    }),\r\n    canUndo: () => proxyObject.history.index > 0,\r\n    undo: () => {\r\n      if (proxyObject.canUndo()) {\r\n        proxyObject.value = proxyObject.history.wip = proxyObject.history.snapshots[--proxyObject.history.index];\r\n      }\r\n    },\r\n    canRedo: () => proxyObject.history.index < proxyObject.history.snapshots.length - 1,\r\n    redo: () => {\r\n      if (proxyObject.canRedo()) {\r\n        proxyObject.value = proxyObject.history.wip = proxyObject.history.snapshots[++proxyObject.history.index];\r\n      }\r\n    },\r\n    saveHistory: () => {\r\n      proxyObject.history.snapshots.splice(proxyObject.history.index + 1);\r\n      proxyObject.history.snapshots.push(snapshot(proxyObject).value);\r\n      ++proxyObject.history.index;\r\n    }\r\n  });\r\n  subscribe(proxyObject, (ops) => {\r\n    if (ops.some((op) => op[1][0] === \"value\" && (op[0] !== \"set\" || op[2] !== proxyObject.history.wip))) {\r\n      proxyObject.saveHistory();\r\n    }\r\n  });\r\n  return proxyObject;\r\n};\r\n\r\nexport { addComputed, devtools, proxyWithComputed, proxyWithHistory, subscribeKey, watch };\r\n"],
  "mappings": "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",
  "names": []
}
